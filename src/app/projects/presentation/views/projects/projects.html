<div class="projects-container">
  <!-- Header Section -->
  <div class="projects-header">
    <div class="header-top">
      <h1 class="projects-title">{{ 'projects.title' | translate }}</h1>

      <!-- Currency Indicator -->
      <div class="currency-indicator">
        <svg class="icon-small">
          <use href="assets/icons/sprite.symbol.svg#dollar-sign"></use>
        </svg>
        <span class="currency-label">{{ 'projects.currency.viewing' | translate }}: </span>
        <strong>{{ getUserCurrencyName() }}</strong>
        @if (userCurrencyId() !== 1) {
          <span class="exchange-info" [title]="'Tipo de cambio: 1 USD = S/ ' + currencyService.getExchangeRate()">
            (TC: {{ currencyService.getExchangeRate() }})
          </span>
        }
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <label for="search" class="filter-label">{{ 'projects.filter.label' | translate }}</label>
      <div class="filter-controls">
        <input
          type="text"
          id="search"
          [(ngModel)]="searchTerm"
          class="filter-input"
          [placeholder]="'projects.filter.placeholder' | translate">
        <button
          type="button"
          class="btn-filter"
          (click)="onApplyFilter()">
          {{ 'projects.filter.apply' | translate }}
        </button>
        @if (searchTerm()) {
          <button
            type="button"
            class="btn-clear"
            (click)="onClearFilter()">
            <svg class="icon-small">
              <use href="assets/icons/sprite.symbol.svg#x"></use>
            </svg>
          </button>
        }
      </div>
    </div>

    <!-- Add New Button -->
    <button
      type="button"
      class="btn-add"
      (click)="onCreateProperty()">
      <svg class="icon-small">
        <use href="assets/icons/sprite.symbol.svg#plus"></use>
      </svg>
      {{ 'projects.buttons.add' | translate }}
    </button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ 'projects.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="alert alert-error">
      <svg class="alert-icon">
        <use href="assets/icons/sprite.symbol.svg#alert-circle"></use>
      </svg>
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Properties Table -->
  @if (!loading() && !error()) {
    <div class="table-container">
      <table class="properties-table">
        <thead>
          <tr>
            <th>{{ 'projects.table.code' | translate }}</th>
            <th>{{ 'projects.table.project' | translate }}</th>
            <th>{{ 'projects.table.type' | translate }}</th>
            <th>{{ 'projects.table.area' | translate }}</th>
            <th>{{ 'projects.table.price' | translate }}</th>
            <th>{{ 'projects.table.status' | translate }}</th>
            <th>{{ 'projects.table.availability' | translate }}</th>
            <th>{{ 'projects.table.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredProperties().length === 0) {
            <tr>
              <td colspan="8" class="empty-message">
                {{ 'projects.noResults' | translate }}
              </td>
            </tr>
          } @else {
            @for (property of filteredProperties(); track property.entity.id) {
              <tr>
                <td class="code-cell">{{ property.entity.property_code }}</td>
                <td class="project-cell">{{ property.entity.project }}</td>
                <td>{{ property.entity.type }}</td>
                <td>{{ property.entity.area }} m²</td>
                <td class="price-cell">
                  <div class="price-display">
                    <span class="converted-price">
                      {{ formatCurrency(property.displayPrice, property.displayCurrencyId) }}
                    </span>
                    @if (property.originalCurrencyId !== property.displayCurrencyId) {
                      <span class="original-price" [title]="'Precio original: ' + formatCurrency(property.originalPrice, property.originalCurrencyId)">
                        ({{ getCurrencyCode(property.originalCurrencyId) }})
                      </span>
                    }
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(property.entity.status)">
                    {{ getStatusTranslation(property.entity.status) }}
                  </span>
                </td>
                <td class="availability-cell">{{ property.entity.availability }}</td>
                <td>
                  <div class="action-buttons">
                    <button
                      type="button"
                      class="btn-icon"
                      (click)="onEditProperty(property.entity)"
                      [title]="'projects.buttons.edit' | translate">
                      <svg class="icon-small">
                        <use href="assets/icons/sprite.symbol.svg#edit"></use>
                      </svg>
                    </button>
                    <button
                      type="button"
                      class="btn-icon btn-danger"
                      (click)="onDeleteProperty(property.entity.id)"
                      [title]="'projects.buttons.delete' | translate">
                      <svg class="icon-small">
                        <use href="assets/icons/sprite.symbol.svg#x"></use>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <!-- Summary -->
    <div class="table-summary">
      <p>
        {{ 'projects.summary.total' | translate }}:
        <strong>{{ filteredProperties().length }}</strong>
        @if (searchTerm()) {
          ({{ 'projects.summary.filtered' | translate }}: {{ properties().length }})
        }
      </p>
    </div>
  }

  <!-- Form Modal -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="onCloseForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            @if (editingProject()) {
              {{ 'projects.form.titleEdit' | translate }}
            } @else {
              {{ 'projects.form.titleCreate' | translate }}
            }
          </h2>
          <button type="button" class="btn-close" (click)="onCloseForm()">
            <svg class="icon-small">
              <use href="assets/icons/sprite.symbol.svg#x"></use>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <form [formGroup]="propertyForm" (ngSubmit)="onSubmitForm()" class="property-form">
            <!-- Datos Generales Section -->
            <div class="form-section">
              <h3 class="section-title">{{ 'projects.form.sections.general' | translate }}</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="property_code" class="form-label">
                    {{ 'projects.form.fields.code' | translate }}
                  </label>
                  <input
                    type="text"
                    id="property_code"
                    formControlName="property_code"
                    class="form-input"
                    [class.invalid]="propertyForm.get('property_code')?.invalid && propertyForm.get('property_code')?.touched"
                    [placeholder]="'projects.form.placeholders.code' | translate">
                  @if (propertyForm.get('property_code')?.invalid && propertyForm.get('property_code')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="project" class="form-label">
                    {{ 'projects.form.fields.project' | translate }}
                  </label>
                  <input
                    type="text"
                    id="project"
                    formControlName="project"
                    class="form-input"
                    [class.invalid]="propertyForm.get('project')?.invalid && propertyForm.get('project')?.touched"
                    [placeholder]="'projects.form.placeholders.project' | translate">
                  @if (propertyForm.get('project')?.invalid && propertyForm.get('project')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="type" class="form-label">
                    {{ 'projects.form.fields.type' | translate }}
                  </label>
                  <input
                    type="text"
                    id="type"
                    formControlName="type"
                    class="form-input"
                    [class.invalid]="propertyForm.get('type')?.invalid && propertyForm.get('type')?.touched"
                    [placeholder]="'projects.form.placeholders.type' | translate">
                  @if (propertyForm.get('type')?.invalid && propertyForm.get('type')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="status" class="form-label">
                    {{ 'projects.form.fields.status' | translate }}
                  </label>
                  <select
                    id="status"
                    formControlName="status"
                    class="form-input"
                    [class.invalid]="propertyForm.get('status')?.invalid && propertyForm.get('status')?.touched">
                    <option value="pending">{{ 'projects.form.fields.statusOptions.pending' | translate }}</option>
                    <option value="in_evaluation">{{ 'projects.form.fields.statusOptions.in_evaluation' | translate }}</option>
                    <option value="approved">{{ 'projects.form.fields.statusOptions.approved' | translate }}</option>
                    <option value="rejected">{{ 'projects.form.fields.statusOptions.rejected' | translate }}</option>
                  </select>
                  @if (propertyForm.get('status')?.invalid && propertyForm.get('status')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="availabitility" class="form-label">
                    {{ 'projects.form.fields.availability' | translate }}
                  </label>
                  <input
                      type="number"
                      id="availability"
                      formControlName="availability"
                      class="form-input"
                      [class.invalid]="propertyForm.get('availability')?.invalid && propertyForm.get('availability')?.touched"
                      [placeholder]="'projects.form.placeholders.availability' | translate"/>
                  @if (propertyForm.get('availability')?.invalid && propertyForm.get('availability')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>
            </div>

            <!-- Características Físicas Section -->
            <div class="form-section">
              <h3 class="section-title">{{ 'projects.form.sections.physical' | translate }}</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="area" class="form-label">
                    {{ 'projects.form.fields.area' | translate }}
                  </label>
                  <input
                    type="number"
                    id="area"
                    formControlName="area"
                    class="form-input"
                    [class.invalid]="propertyForm.get('area')?.invalid && propertyForm.get('area')?.touched"
                    [placeholder]="'projects.form.placeholders.area' | translate">
                  @if (propertyForm.get('area')?.invalid && propertyForm.get('area')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>
            </div>

            <!-- Datos Económicos Section -->
            <div class="form-section">
              <h3 class="section-title">{{ 'projects.form.sections.economic' | translate }}</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="price" class="form-label">
                    {{ 'projects.form.fields.price' | translate }}
                  </label>
                  <input
                    type="number"
                    id="price"
                    formControlName="price"
                    class="form-input"
                    [class.invalid]="propertyForm.get('price')?.invalid && propertyForm.get('price')?.touched"
                    [placeholder]="'projects.form.placeholders.price' | translate">
                  @if (propertyForm.get('price')?.invalid && propertyForm.get('price')?.touched) {
                    <span class="error-message">{{ 'projects.form.errors.required' | translate }}</span>
                  }
                </div>
              </div>

              <div class="form-row form-row-buttons">
                <button
                  type="button"
                  class="btn-currency"
                  [class.active]="propertyForm.get('currency_catalog_id')?.value === 1"
                  (click)="onSelectCurrency(1)">
                  {{ 'projects.form.currency.soles' | translate }}
                </button>
                <button
                  type="button"
                  class="btn-currency"
                  [class.active]="propertyForm.get('currency_catalog_id')?.value === 2"
                  (click)="onSelectCurrency(2)">
                  {{ 'projects.form.currency.dollars' | translate }}
                </button>
              </div>
            </div>

            <!-- Ubicación Section -->
            <div class="form-section">
              <h3 class="section-title">{{ 'projects.form.sections.location' | translate }}</h3>

              <div class="form-row form-row-two">
                <div class="form-group">
                  <label for="address" class="form-label">
                    {{ 'projects.form.fields.address' | translate }}
                  </label>
                  <input
                    type="text"
                    id="address"
                    formControlName="address"
                    class="form-input"
                    [placeholder]="'projects.form.placeholders.address' | translate">
                </div>

                <div class="form-group">
                  <label for="district" class="form-label">
                    {{ 'projects.form.fields.district' | translate }}
                  </label>
                  <input
                    type="text"
                    id="district"
                    formControlName="district"
                    class="form-input"
                    [placeholder]="'projects.form.placeholders.district' | translate">
                </div>
                <div class="form-group">
                  <label for="province" class="form-label">
                    {{ 'projects.form.fields.province' | translate }}
                  </label>
                  <input
                    type="text"
                    id="province"
                    formControlName="province"
                    class="form-input"
                    [placeholder]="'projects.form.placeholders.province' | translate">
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button
                type="submit"
                class="btn-submit"
                [disabled]="formSubmitting()">
                @if (formSubmitting()) {
                  @if (editingProject()) {
                    {{ 'projects.form.buttons.updating' | translate }}
                  } @else {
                    {{ 'projects.form.buttons.saving' | translate }}
                  }
                } @else {
                  @if (editingProject()) {
                    {{ 'projects.form.buttons.update' | translate }}
                  } @else {
                    {{ 'projects.form.buttons.save' | translate }}
                  }
                }
              </button>
              <button
                type="button"
                class="btn-cancel"
                (click)="onCloseForm()">
                {{ 'projects.form.buttons.cancel' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>

